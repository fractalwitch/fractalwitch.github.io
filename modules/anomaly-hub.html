<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sacramento Celestial Portal v7.1</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Base Dark Mode */
        body {
            background-color: #030014;
            color: #e2e8f0;
            font-family: 'Space Mono', monospace;
            overflow-x: hidden;
            transition: background-color 0.5s ease;
        }
        h1, h2, h3, .font-cinzel { font-family: 'Cinzel', serif; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.5); border-radius: 4px; }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 6s ease-in-out infinite; will-change: transform; }
        
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .animate-marquee { animation: marquee 90s linear infinite; will-change: transform; }
        .animate-marquee:hover { animation-play-state: paused; }
        
        @keyframes gentle-pulse {
            0% { transform: scale(1); border-color: rgba(255,255,255,0.1); }
            50% { transform: scale(0.99); border-color: rgba(168,85,247,0.5); }
            100% { transform: scale(1); border-color: rgba(255,255,255,0.1); }
        }
        .animate-edit-mode { animation: gentle-pulse 2s infinite ease-in-out; cursor: crosshair; }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            transform: translateZ(0);
        }
        .glass-panel:hover {
            border-color: rgba(167, 139, 250, 0.5);
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.15);
        }
        
        .overlay-backdrop { background: rgba(3, 0, 20, 0.85); backdrop-filter: blur(8px); }
        .weather-icon-anim { animation: float 4s ease-in-out infinite; will-change: transform; }
        
        .selected-for-swap {
            border-color: #a855f7 !important;
            box-shadow: 0 0 30px rgba(168,85,247,0.5) !important;
            transform: scale(1.01);
            z-index: 50;
            background: rgba(20, 30, 60, 0.95);
        }

        /* Desire item strikethrough */
        .desire-completed {
            text-decoration: line-through;
            opacity: 0.5;
        }
        
        .desire-checkbox {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(236, 72, 153, 0.5);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .desire-checkbox:checked {
            background: linear-gradient(135deg, #ec4899, #a855f7);
            border-color: #ec4899;
        }
        .desire-checkbox:checked::after {
            content: 'âœ“';
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Time clock clickable */
        .time-clock {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }
        .time-clock:hover {
            text-shadow: 0 0 20px rgba(168, 85, 247, 0.6);
        }
        .time-clock:active {
            transform: scale(0.98);
        }

        /* --- DIVINE MODE (Light/Maximalist) --- */
        body.divine-mode {
            background: linear-gradient(45deg, #ff00cc, #333399, #00ffff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #fff;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .divine-mode .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur( 8px );
            -webkit-backdrop-filter: blur( 8px );
        }
        .divine-mode .glass-panel:hover {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 40px rgba(255, 0, 255, 0.6);
            border-color: rgba(255, 255, 255, 0.8);
        }
        .divine-mode .text-slate-500 { color: rgba(255,255,255,0.7) !important; }
        .divine-mode .text-slate-300 { color: #fff !important; }
        .divine-mode .text-slate-400 { color: rgba(255,255,255,0.8) !important; }
        .divine-mode .bg-black\/20 { background: rgba(0,0,0,0.2); }
        
        .divine-mode h1 {
            text-shadow: 2px 2px 0px #ff00ff, -2px -2px 0px #00ffff;
        }

        /* Improved Grid Layout */
        .portal-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
            align-items: stretch;
            justify-content: center;
        }
        
        @media (min-width: 768px) {
            .portal-grid {
                gap: 2rem;
            }
        }
        
        .module-container {
            display: flex;
            flex-direction: column;
        }
        
        .module-container .glass-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useMemo, useRef, memo, useCallback } = React;

    // --- UTILS ---
    const Icon = ({ name, size = 24, className = "" }) => {
        useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
        return <i data-lucide={name} width={size} height={size} className={className}></i>;
    };

    const Overlay = ({ title, onClose, children }) => (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 overlay-backdrop animate-in fade-in duration-200" onClick={onClose}>
            <div className="bg-[#0f172a] border border-purple-500/30 w-full max-w-2xl max-h-[80vh] rounded-3xl overflow-hidden flex flex-col shadow-[0_0_50px_rgba(168,85,247,0.3)]" onClick={e => e.stopPropagation()}>
                <div className="p-6 border-b border-white/10 flex justify-between items-center bg-purple-900/20">
                    <h2 className="text-xl font-cinzel text-purple-200">{title}</h2>
                    <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition-colors">
                        <Icon name="x" size={20} />
                    </button>
                </div>
                <div className="p-6 overflow-y-auto custom-scrollbar">
                    {children}
                </div>
            </div>
        </div>
    );

    // --- ISOLATED COMPONENTS ---

    const SeismicGraph = memo(({ data }) => {
        if (!data || data.length === 0) return <div className="h-16 flex items-center justify-center text-[10px] text-slate-500">NO DATA</div>;
        const sorted = [...data].sort((a, b) => a.properties.time - b.properties.time);
        const maxMag = Math.max(...sorted.map(d => d.properties.mag)) || 5;
        const height = 60, width = 100;
        const points = sorted.map((d, i) => {
            const x = (i / (sorted.length - 1)) * width;
            const y = height - ((d.properties.mag / maxMag) * height * 0.8) - 5; 
            return `${x},${y}`;
        }).join(' ');
        return (
            <div className="w-full h-16 bg-black/20 rounded-lg mb-3 relative overflow-hidden flex items-end px-1 border border-white/5">
                <div className="absolute top-1 left-2 text-[8px] text-slate-500 font-mono">INTENSITY (24H)</div>
                <svg className="w-full h-full" viewBox={`0 0 ${width} ${height}`} preserveAspectRatio="none">
                    <polyline points={points} fill="none" stroke="rgba(244, 63, 94, 0.6)" strokeWidth="1.5" />
                    {sorted.map((d, i) => {
                        const x = (i / (sorted.length - 1)) * width;
                        const y = height - ((d.properties.mag / maxMag) * height * 0.8) - 5;
                        return <circle key={i} cx={x} cy={y} r="1" fill="#fda4af" />
                    })}
                </svg>
            </div>
        );
    });

    // --- ISOLATED CLOCK COMPONENT (prevents page-wide re-renders) ---
    const ClockDisplay = memo(({ timezone, location }) => {
        const [currentTime, setCurrentTime] = useState(new Date());
        const [timeFormat, setTimeFormat] = useState(() => {
            const saved = localStorage.getItem('portal_time_format');
            return saved || '24hr';
        });

        useEffect(() => {
            const t = setInterval(() => setCurrentTime(new Date()), 1000);
            return () => clearInterval(t);
        }, []);

        useEffect(() => {
            localStorage.setItem('portal_time_format', timeFormat);
        }, [timeFormat]);

        const toggleTimeFormat = () => {
            setTimeFormat(prev => prev === '24hr' ? '12hr' : '24hr');
        };

        const getFormattedTime = () => {
            if (timeFormat === '24hr') {
                return currentTime.toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: timezone 
                });
            } else {
                return currentTime.toLocaleTimeString('en-US', { 
                    hour12: true, 
                    hour: 'numeric',
                    minute: '2-digit',
                    timeZone: timezone 
                });
            }
        };

        return (
            <div className="flex flex-col items-center md:items-end">
                <div 
                    onClick={toggleTimeFormat}
                    className="time-clock text-4xl font-mono text-white tracking-widest"
                    title={`Click to switch to ${timeFormat === '24hr' ? '12-hour' : '24-hour'} format`}
                >
                    {getFormattedTime()}
                </div>
                <div className="flex items-center gap-2 text-purple-300/50 text-xs uppercase tracking-[0.2em] mt-1">
                    <span>{currentTime.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: timezone })}</span>
                    <span className="text-[8px] px-1.5 py-0.5 rounded bg-purple-500/20 text-purple-300/70">{timeFormat === '24hr' ? 'MIL' : 'STD'}</span>
                </div>
            </div>
        );
    });

    // --- DAILY DESIRES COMPONENT ---
    const DailyDesires = memo(({ desires, setDesires }) => {
        const [newDesire, setNewDesire] = useState('');
        
        const addDesire = () => {
            if (!newDesire.trim()) return;
            const updated = [...desires, { id: Date.now(), text: newDesire.trim(), completed: false }];
            setDesires(updated);
            setNewDesire('');
        };
        
        const toggleDesire = (id) => {
            const updated = desires.map(d => d.id === id ? { ...d, completed: !d.completed } : d);
            setDesires(updated);
        };
        
        const updateDesireText = (id, text) => {
            const updated = desires.map(d => d.id === id ? { ...d, text } : d);
            setDesires(updated);
        };
        
        const removeDesire = (id) => {
            const updated = desires.filter(d => d.id !== id);
            setDesires(updated);
        };
        
        return (
            <div className="glass-panel rounded-3xl p-6 relative overflow-hidden flex flex-col h-full min-h-[16rem]">
                <div className="flex items-center gap-2 text-pink-300 mb-4">
                    <Icon name="heart" size={18} />
                    <span className="text-xs font-bold tracking-widest uppercase">Daily Desires</span>
                </div>
                
                {/* Add new desire */}
                <div className="flex gap-2 mb-4">
                    <input
                        type="text"
                        placeholder="Plant a seed..."
                        value={newDesire}
                        onChange={(e) => setNewDesire(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && addDesire()}
                        className="flex-1 bg-black/30 border border-pink-500/30 rounded-lg px-3 py-2 text-sm text-pink-100 placeholder-pink-300/40 outline-none focus:border-pink-400/60 transition-colors"
                    />
                    <button 
                        onClick={addDesire}
                        className="px-3 py-2 bg-pink-500/20 border border-pink-500/30 rounded-lg text-pink-300 hover:bg-pink-500/30 transition-colors"
                    >
                        <Icon name="plus" size={16} />
                    </button>
                </div>
                
                {/* Desires list - scrollable */}
                <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-1">
                    {desires.length === 0 ? (
                        <div className="text-center text-pink-300/40 text-xs py-8 italic">
                            What does your heart desire today?
                        </div>
                    ) : (
                        desires.map((desire) => (
                            <div 
                                key={desire.id} 
                                className={`flex items-center gap-3 p-3 rounded-lg bg-black/20 border border-white/5 group transition-all ${desire.completed ? 'opacity-60' : ''}`}
                            >
                                <input
                                    type="checkbox"
                                    checked={desire.completed}
                                    onChange={() => toggleDesire(desire.id)}
                                    className="desire-checkbox"
                                />
                                <input
                                    type="text"
                                    value={desire.text}
                                    onChange={(e) => updateDesireText(desire.id, e.target.value)}
                                    className={`flex-1 bg-transparent border-none outline-none text-sm text-pink-100/80 ${desire.completed ? 'desire-completed' : ''}`}
                                />
                                <button 
                                    onClick={() => removeDesire(desire.id)}
                                    className="opacity-0 group-hover:opacity-100 text-pink-400/50 hover:text-pink-400 transition-all"
                                >
                                    <Icon name="x" size={14} />
                                </button>
                            </div>
                        ))
                    )}
                </div>
                
                {/* Progress indicator */}
                {desires.length > 0 && (
                    <div className="mt-3 pt-3 border-t border-white/10">
                        <div className="flex justify-between text-[10px] text-pink-300/50 font-mono mb-1">
                            <span>MANIFESTED</span>
                            <span>{desires.filter(d => d.completed).length}/{desires.length}</span>
                        </div>
                        <div className="h-1 bg-black/30 rounded-full overflow-hidden">
                            <div 
                                className="h-full bg-gradient-to-r from-pink-500 to-purple-500 transition-all duration-500"
                                style={{ width: `${(desires.filter(d => d.completed).length / desires.length) * 100}%` }}
                            />
                        </div>
                    </div>
                )}
            </div>
        );
    });

    // --- MAIN APP ---

    const CelestialPortal = () => {
        // State
        const [location, setLocation] = useState({ 
            name: "Sacramento, CA", 
            lat: 38.5816, 
            lon: -121.4944, 
            timezone: "America/Los_Angeles",
            country: "US"
        });
        
        // Static calculation time - only updates every 5 minutes for astronomical calculations
        // (Moon phase and planets don't change noticeably every second)
        const [calcTime, setCalcTime] = useState(new Date());
        
        const [solarData, setSolarData] = useState(null);
        const [quakeData, setQuakeData] = useState([]);
        const [newsData, setNewsData] = useState([]);
        const [weatherData, setWeatherData] = useState(null);
        
        // Daily Desires state with persistence
        const [desires, setDesires] = useState(() => {
            const saved = localStorage.getItem('portal_desires');
            return saved ? JSON.parse(saved) : [];
        });
        
        // Sorting
        const [isSorting, setIsSorting] = useState(false);
        const [selectedForSwap, setSelectedForSwap] = useState(null);
        const [moduleOrder, setModuleOrder] = useState(() => {
            const saved = localStorage.getItem('portal_order_v5');
            return saved ? JSON.parse(saved) : ['moon', 'desires', 'solar', 'sky', 'weather', 'seismic'];
        });

        // Search State
        const [isSearching, setIsSearching] = useState(false);
        const [searchQuery, setSearchQuery] = useState("");

        // Divine Mode
        const [divineMode, setDivineMode] = useState(false);

        // Expanded
        const [expanded, setExpanded] = useState({ moon: false, solar: false, sky: false, weather: false, news: false });
        const toggleExpand = (key, val) => setExpanded(prev => ({...prev, [key]: val}));

        // Updated NASA API Key
        const NASA_API_KEY = "K2aCj4HFtTSCgKxilD8WAAkmqCuM6uUCzQdq0xlx"; 

        // --- EFFECTS ---

        // Save desires to localStorage
        useEffect(() => {
            localStorage.setItem('portal_desires', JSON.stringify(desires));
        }, [desires]);

        useEffect(() => {
            if (divineMode) document.body.classList.add('divine-mode');
            else document.body.classList.remove('divine-mode');
        }, [divineMode]);

        // Update calculation time every 5 minutes (astronomical data doesn't need second-by-second updates)
        useEffect(() => {
            const t = setInterval(() => setCalcTime(new Date()), 300000); // 5 minutes
            return () => clearInterval(t);
        }, []);

        // Data Fetching (Re-runs when location changes)
        useEffect(() => {
            const load = async () => {
                const end = new Date().toISOString().split('T')[0];
                const start = new Date(Date.now() - 2592000000).toISOString().split('T')[0]; // 30 Days

                // Solar
                try {
                    const r = await fetch(`https://api.nasa.gov/DONKI/FLR?startDate=${start}&endDate=${end}&api_key=${NASA_API_KEY}`);
                    if (!r.ok) throw new Error("API Limit");
                    const d = await r.json();
                    if(Array.isArray(d) && d.length > 0) {
                        setSolarData(d.sort((a,b) => (b.classType[0]==='X'?1000:1) * parseFloat(b.classType.slice(1)) - (a.classType[0]==='X'?1000:1) * parseFloat(a.classType.slice(1))));
                    } else {
                        setSolarData([{classType: "QUIET", activeRegionNum: "N/A", beginTime: new Date().toISOString()}]);
                    }
                } catch(e) {
                    setSolarData([{classType: "QUIET", activeRegionNum: "N/A", beginTime: new Date().toISOString()}]);
                }

                // Seismic
                try {
                    const r = await fetch("https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_day.geojson");
                    const d = await r.json();
                    setQuakeData(d.features.slice(0, 20));
                } catch(e) {}

                // Weather (Dynamic Location with Celsius for Canada)
                try {
                    const tempUnit = location.country === 'CA' ? 'celsius' : 'fahrenheit';
                    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${location.lat}&longitude=${location.lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,sunrise,sunset&current_weather=true&temperature_unit=${tempUnit}&timezone=auto`);
                    const d = await r.json();
                    setWeatherData({ ...d, tempUnit });
                } catch(e) {}

                // News
                try {
                    const rssUrls = ["https://rss.nytimes.com/services/xml/rss/nyt/Space.xml", "https://www.goodnewsnetwork.org/feed/"];
                    const promises = rssUrls.map(url => fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`).then(res => res.json()));
                    const results = await Promise.all(promises);
                    let allItems = results.flatMap(r => r.items ? r.items : []);
                    allItems = allItems.map(i => ({ title: i.title, link: i.link, source: i.link.includes("goodnews") ? "GOOD NEWS" : "SPACE FEED" }));
                    const signals = [
                        { title: ">>> SIGNAL RECEIVED: Global Coherence 99.8%", link: "#", source: "NOOSPHERE" },
                        { title: ">>> EVENT: Latent Energy Shift in Sector 4", link: "#", source: "GAIA" }
                    ];
                    setNewsData([...allItems.slice(0, 15), ...signals].sort(() => Math.random() - 0.5));
                } catch(e) {
                    setNewsData([{ title: "Awaiting Uplink...", link: "#", source: "SYSTEM" }]);
                }
            };
            load();
        }, [location]);

        // --- MATH ENGINE ---

        // Planetary Engine (Keplerian -> Geocentric)
        const planetInfo = useMemo(() => {
            const date = calcTime;
            const time = date.getTime();
            const jd = (time / 86400000) - (date.getTimezoneOffset() / 1440) + 2440587.5;
            const D = jd - 2451543.5;
            const rad = Math.PI / 180;
            const deg = 180 / Math.PI;

            const planets = {
                Mercury: { N: 48.3313, i: 7.0047, w: 29.1241, a: 0.387098, e: 0.205635, M: 168.6562, n: 4.0923344368 },
                Venus: { N: 76.6799, i: 3.3946, w: 54.8910, a: 0.723330, e: 0.006773, M: 48.0052, n: 1.6021302244 },
                Earth: { N: 0.0, i: 0.0, w: 282.9404, a: 1.000000, e: 0.016709, M: 356.0470, n: 0.9856002585 },
                Mars: { N: 49.5574, i: 1.8497, w: 286.5016, a: 1.523688, e: 0.093405, M: 18.6021, n: 0.5240207766 },
                Jupiter: { N: 100.4542, i: 1.3030, w: 273.8777, a: 5.20256, e: 0.048498, M: 19.8950, n: 0.0830853001 },
                Saturn: { N: 113.6634, i: 2.4886, w: 339.3939, a: 9.55475, e: 0.055546, M: 316.9670, n: 0.0334442282 },
                Uranus: { N: 74.0005, i: 0.7733, w: 96.6612, a: 19.18171, e: 0.047318, M: 142.5905, n: 0.011725806 },
                Neptune: { N: 131.7806, i: 1.7700, w: 272.8461, a: 30.05826, e: 0.008606, M: 260.2471, n: 0.005995147 }
            };

            const zodiac = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"];
            const elements = ["Fire", "Earth", "Air", "Water", "Fire", "Earth", "Air", "Water", "Fire", "Earth", "Air", "Water"];

            const getPos = (p, d_offset = 0) => {
                const M_p = (p.M + p.n * (D + d_offset)) % 360;
                const M_rad = M_p * rad;
                const E = M_p + (180/Math.PI) * p.e * Math.sin(M_rad) * (1 + p.e * Math.cos(M_rad));
                const E_rad = E * rad;
                const xv = p.a * (Math.cos(E_rad) - p.e);
                const yv = p.a * (Math.sqrt(1 - p.e*p.e) * Math.sin(E_rad));
                const v = Math.atan2(yv, xv) * deg;
                const r = Math.sqrt(xv*xv + yv*yv);
                const l = v + p.w;
                const x = r * Math.cos(l * rad);
                const y = r * Math.sin(l * rad);
                const z = 0;
                return { x, y, z, l };
            };

            const earthNow = getPos(planets.Earth);
            const earthPrev = getPos(planets.Earth, -0.1);

            return Object.keys(planets).filter(k => k !== 'Earth').map(key => {
                const p = planets[key];
                const pNow = getPos(p);
                const pPrev = getPos(p, -0.1);

                const dx = pNow.x - earthNow.x;
                const dy = pNow.y - earthNow.y;
                const geoLong = (Math.atan2(dy, dx) * deg + 360) % 360;

                const dx_prev = pPrev.x - earthPrev.x;
                const dy_prev = pPrev.y - earthPrev.y;
                const geoLong_prev = (Math.atan2(dy_prev, dx_prev) * deg + 360) % 360;

                let diff = geoLong - geoLong_prev;
                if (diff < -300) diff += 360;
                if (diff > 300) diff -= 360;
                
                const isRetro = diff < 0;

                const signIdx = Math.floor(geoLong / 30);
                const degree = geoLong % 30;

                return {
                    name: key,
                    sign: zodiac[signIdx],
                    element: elements[signIdx],
                    degree: degree.toFixed(1),
                    isRetrograde: isRetro
                };
            });
        }, [calcTime]);

        const moonInfo = useMemo(() => {
            const jd = (calcTime.getTime() / 86400000) - (calcTime.getTimezoneOffset() / 1440) + 2440587.5;
            const daysSinceNew = jd - 2451549.5; 
            const progress = (daysSinceNew % 29.53059) / 29.53059;
            const phaseIndex = Math.floor(progress * 8);
            const phases = [{name:"New Moon",icon:"ðŸŒ‘"},{name:"Waxing Crescent",icon:"ðŸŒ’"},{name:"First Quarter",icon:"ðŸŒ“"},{name:"Waxing Gibbous",icon:"ðŸŒ”"},{name:"Full Moon",icon:"ðŸŒ•"},{name:"Waning Gibbous",icon:"ðŸŒ–"},{name:"Last Quarter",icon:"ðŸŒ—"},{name:"Waning Crescent",icon:"ðŸŒ˜"}];
            return { ...phases[phaseIndex], illumination: ((Math.sin(progress * Math.PI * 2 - Math.PI / 2) + 1) * 50).toFixed(1), age: (progress * 29.53).toFixed(1), rawProgress: progress };
        }, [calcTime]);

        const getMonthlyMoons = () => {
            const moons = [];
            const now = new Date();
            const days = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            for(let i=1; i<=days; i++) {
                const d = new Date(now.getFullYear(), now.getMonth(), i);
                const jd = (d.getTime() / 86400000) - (d.getTimezoneOffset() / 1440) + 2440587.5;
                const daysSinceNew = jd - 2451549.5; 
                const progress = (daysSinceNew % 29.53059) / 29.53059;
                const phaseIndex = Math.floor(progress * 8);
                const phases = [{name:"New",icon:"ðŸŒ‘"},{name:"Waxing",icon:"ðŸŒ’"},{name:"First",icon:"ðŸŒ“"},{name:"Waxing",icon:"ðŸŒ”"},{name:"Full",icon:"ðŸŒ•"},{name:"Waning",icon:"ðŸŒ–"},{name:"Last",icon:"ðŸŒ—"},{name:"Waning",icon:"ðŸŒ˜"}];
                moons.push({ date: i, ...phases[phaseIndex] });
            }
            return moons;
        };
        const monthlyMoons = useMemo(() => getMonthlyMoons(), [calcTime]);

        const formatTime = (t) => new Date(t).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', timeZone: location.timezone });
        const getWeatherIcon = (c) => c === 0 ? "sun" : c < 3 ? "cloud-sun" : c < 50 ? "cloud" : c < 80 ? "cloud-rain" : "cloud-lightning";

        // --- HANDLERS ---

        const handleLocationSearch = async () => {
            if(!searchQuery) return;
            setIsSearching(false);
            try {
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(searchQuery)}&count=1&language=en&format=json`);
                const data = await res.json();
                if (data.results && data.results.length > 0) {
                    const place = data.results[0];
                    if(['US','CA'].includes(place.country_code)) {
                        setLocation({
                            name: `${place.name}, ${place.admin1 || place.country_code}`,
                            lat: place.latitude,
                            lon: place.longitude,
                            timezone: place.timezone,
                            country: place.country_code
                        });
                    } else {
                        alert("Please select a city in US or Canada.");
                    }
                }
            } catch(e) {
                console.error("Geocoding failed");
            }
        };

        const handleSaveOrder = () => {
            localStorage.setItem('portal_order_v5', JSON.stringify(moduleOrder));
            setIsSorting(false);
            setSelectedForSwap(null);
        };

        // --- GRID RENDERING ---

        const ModuleWrapper = ({ id, colSpan, children }) => {
            const isSelected = selectedForSwap === id;
            const handleClick = (e) => {
                if (!isSorting) return; 
                e.stopPropagation(); 
                if (selectedForSwap === null) setSelectedForSwap(id);
                else if (selectedForSwap === id) setSelectedForSwap(null);
                else {
                    const newOrder = [...moduleOrder];
                    const idxA = newOrder.indexOf(selectedForSwap);
                    const idxB = newOrder.indexOf(id);
                    newOrder[idxA] = id;
                    newOrder[idxB] = selectedForSwap;
                    setModuleOrder(newOrder);
                    setSelectedForSwap(null);
                }
            };
            return (
                <div onClick={handleClick} className={`module-container ${colSpan} transition-all duration-300 ${isSorting ? 'animate-edit-mode' : ''} ${isSelected ? 'selected-for-swap' : ''}`}>
                    <div className={`h-full ${isSorting ? 'pointer-events-none' : ''}`}>{children}</div>
                </div>
            );
        };

        const renderModule = (id) => {
            const peakFlare = solarData?.[0];
            const tempSymbol = weatherData?.tempUnit === 'celsius' ? 'Â°C' : 'Â°F';
            
            switch(id) {
                case 'moon':
                    return (
                        <div onClick={() => toggleExpand('moon', true)} className="glass-panel rounded-3xl p-8 flex flex-col items-center justify-center relative overflow-hidden group cursor-pointer h-full min-h-[18rem]">
                            <div className="absolute top-4 right-4 opacity-50"><Icon name="maximize-2" size={16} className="text-purple-400 opacity-0 group-hover:opacity-100 transition-opacity" /></div>
                            <div className="w-32 h-32 md:w-40 md:h-40 rounded-full bg-slate-900 relative shadow-[0_0_50px_rgba(168,85,247,0.2)] mb-4 animate-float">
                                <div className="absolute inset-0 rounded-full border border-white/10"></div>
                                <div className="absolute inset-0 rounded-full bg-gradient-to-tr from-black via-transparent to-transparent transition-all duration-1000" style={{opacity: moonInfo.type==='New'?0.9:0.2, transform: `rotate(${moonInfo.rawProgress*360}deg)`}}></div>
                                <div className="absolute inset-0 flex items-center justify-center text-5xl filter drop-shadow-[0_0_10px_white]">{moonInfo.icon}</div>
                            </div>
                            <h2 className="text-xl font-cinzel text-purple-100 mb-1">{moonInfo.name}</h2>
                            <div className="flex gap-4 text-[10px] font-mono text-purple-300/70 mt-2">
                                <div className="px-2 py-1 rounded border border-purple-500/30">ILLUM: {moonInfo.illumination}%</div>
                                <div className="px-2 py-1 rounded border border-purple-500/30">AGE: {moonInfo.age}D</div>
                            </div>
                        </div>
                    );
                case 'desires':
                    return <DailyDesires desires={desires} setDesires={setDesires} />;
                case 'solar':
                    return (
                        <div onClick={() => toggleExpand('solar', true)} className="glass-panel rounded-3xl p-6 relative overflow-hidden h-full min-h-[18rem] cursor-pointer group flex flex-col justify-between">
                            <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-50 transition-opacity"><Icon name="maximize-2" size={16} className="text-orange-400" /></div>
                            <div className="absolute -left-10 -bottom-10 w-40 h-40 bg-orange-500/10 rounded-full blur-3xl"></div>
                            <div className="flex justify-between items-start">
                                <div className="flex items-center gap-2 text-orange-300"><Icon name="sun" size={18} /><span className="text-xs font-bold tracking-widest uppercase">Solar Activity</span></div>
                                <span className="text-[10px] font-mono text-orange-400/60">30D MAX</span>
                            </div>
                            <div className="text-center flex-1 flex flex-col justify-center">
                                <div className={`text-5xl font-black font-mono ${peakFlare?.classType.startsWith('X') ? 'text-red-500 drop-shadow-[0_0_15px_red]' : 'text-orange-400'}`}>{peakFlare ? peakFlare.classType : "QUIET"}</div>
                                <div className="text-[10px] text-orange-300/50 mt-1 font-mono uppercase">{peakFlare ? `Active Region ${peakFlare.activeRegionNum}` : "No Activity"}</div>
                            </div>
                        </div>
                    );
                case 'sky':
                    return (
                        <div onClick={() => toggleExpand('sky', true)} className="glass-panel rounded-3xl p-6 relative cursor-pointer group h-full min-h-[18rem]">
                            <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-50 transition-opacity"><Icon name="maximize-2" size={16} className="text-cyan-400" /></div>
                            <div className="flex items-center gap-2 text-cyan-300 mb-4"><Icon name="star" size={18} /><span className="text-xs font-bold tracking-widest uppercase">Sky</span></div>
                            <div className="space-y-2">
                                {planetInfo.slice(0, 4).map((p, i) => (
                                    <div key={i} className="flex justify-between text-xs border-b border-white/5 pb-2">
                                        <span className="text-slate-300 font-bold">{p.name}</span>
                                        <div className="flex items-center gap-2">
                                            <span className="text-cyan-200/70 font-mono">{p.sign}</span>
                                            {p.isRetrograde && <span className="text-[8px] text-red-400 bg-red-900/30 px-1 rounded">Rx</span>}
                                        </div>
                                    </div>
                                ))}
                                <div className="text-[10px] text-center text-cyan-500/50 pt-1">Tap for Alignment</div>
                            </div>
                        </div>
                    );
                case 'weather':
                    return weatherData && (
                        <div onClick={() => toggleExpand('weather', true)} className="glass-panel rounded-3xl p-6 relative cursor-pointer group h-full min-h-[18rem] overflow-hidden flex flex-col justify-between">
                            <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-50 transition-opacity"><Icon name="maximize-2" size={16} className="text-yellow-400" /></div>
                            <div className="flex items-center gap-2 text-yellow-300"><Icon name="cloud-sun" size={18} /><span className="text-xs font-bold tracking-widest uppercase">Local</span></div>
                            <div className="flex items-center justify-between flex-1">
                                <div className="weather-icon-anim text-4xl text-yellow-100"><Icon name={getWeatherIcon(weatherData.current_weather.weathercode)} size={36} /></div>
                                <div className="text-right">
                                    <div className="text-3xl font-mono font-bold text-white">{weatherData.current_weather.temperature}{tempSymbol}</div>
                                    <div className="text-[10px] text-slate-400">WIND: {weatherData.current_weather.windspeed} {weatherData.tempUnit === 'celsius' ? 'km/h' : 'mph'}</div>
                                </div>
                            </div>
                            <div className="flex justify-between mt-2 pt-2 border-t border-white/10 text-[10px] text-slate-400 font-mono">
                                <div className="flex items-center gap-1"><Icon name="sunrise" size={10} /> {formatTime(weatherData.daily.sunrise[0])}</div>
                                <div className="flex items-center gap-1"><Icon name="sunset" size={10} /> {formatTime(weatherData.daily.sunset[0])}</div>
                            </div>
                        </div>
                    );
                case 'seismic':
                    return (
                        <div className="glass-panel rounded-3xl p-6 relative overflow-hidden flex flex-col h-full min-h-[18rem]">
                            <div className="flex items-center gap-2 text-rose-300 mb-2"><Icon name="activity" size={18} /><span className="text-xs font-bold tracking-widest uppercase">Seismic</span></div>
                            <SeismicGraph data={quakeData} />
                            <div className="space-y-2 flex-1 overflow-y-auto custom-scrollbar pr-1 max-h-[100px]">
                                {quakeData.slice(0, 10).map((q, i) => (
                                    <div key={i} className="flex flex-col text-[10px] bg-black/20 p-2 rounded border border-white/5 gap-1">
                                        <div className="flex justify-between items-center">
                                            <div className="truncate max-w-[70%] text-rose-100/80">{q.properties.place}</div>
                                            <div className={`font-bold font-mono px-1 rounded ${q.properties.mag > 4.5 ? 'bg-red-500/30 text-red-200' : 'bg-rose-500/20 text-rose-300'}`}>M{q.properties.mag.toFixed(1)}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                default: return null;
            }
        };

        // Updated column spans for better grid fill
        const getColSpan = (id) => {
            if (id === 'moon') return 'col-span-12 md:col-span-4';
            if (id === 'desires') return 'col-span-12 md:col-span-4';
            if (id === 'solar') return 'col-span-12 md:col-span-4';
            if (id === 'sky') return 'col-span-12 md:col-span-4';
            if (id === 'seismic') return 'col-span-12 md:col-span-4';
            if (id === 'weather') return 'col-span-12 md:col-span-4';
            return 'col-span-12 md:col-span-4';
        };

        return (
            <div className={`min-h-screen relative overflow-x-hidden selection:bg-purple-500 selection:text-white pb-20 ${divineMode ? 'divine-mode' : ''}`}>
                {!divineMode && <div className="fixed inset-0 bg-[radial-gradient(circle_at_50%_100%,#1e1b4b,transparent_60%)] z-0"></div>}
                {!divineMode && <div className="fixed inset-0 z-0 opacity-20" style={{backgroundImage: 'url("https://www.transparenttextures.com/patterns/stardust.png")'}}></div>}

                <main className="relative z-10 max-w-7xl mx-auto p-6 md:p-10 lg:p-14">
                    
                    {/* HEADER */}
                    <header className="flex flex-col md:flex-row justify-between items-center mb-10 border-b border-white/10 pb-8 gap-6">
                        <div className="text-center md:text-left">
                            <h1 className="text-5xl md:text-6xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-200 via-cyan-200 to-purple-200 animate-pulse-glow">PORTAL</h1>
                            
                            {/* CITY SEARCH */}
                            <div className="flex items-center justify-center md:justify-start gap-3 mt-2 text-purple-300/60 font-mono text-sm tracking-widest relative">
                                <Icon name="map-pin" size={14} />
                                {isSearching ? (
                                    <div className="flex items-center gap-2 animate-in fade-in">
                                        <input 
                                            autoFocus
                                            type="text" 
                                            placeholder="City Name..." 
                                            className="bg-black/50 border border-purple-500/50 rounded px-2 py-1 text-white text-xs outline-none w-32"
                                            value={searchQuery}
                                            onChange={e => setSearchQuery(e.target.value)}
                                            onKeyDown={e => e.key === 'Enter' && handleLocationSearch()}
                                        />
                                        <button onClick={handleLocationSearch} className="text-green-400 hover:text-green-300"><Icon name="check" size={14} /></button>
                                        <button onClick={() => setIsSearching(false)} className="text-red-400 hover:text-red-300"><Icon name="x" size={14} /></button>
                                    </div>
                                ) : (
                                    <span onClick={() => setIsSearching(true)} className="cursor-pointer hover:text-purple-200 border-b border-dashed border-transparent hover:border-purple-400 transition-all">
                                        {location.name.toUpperCase()}
                                    </span>
                                )}
                                {!isSearching && <span className="w-1 h-1 rounded-full bg-purple-500"></span>}
                                {!isSearching && <span>{location.lat.toFixed(2)}Â° N</span>}
                            </div>
                        </div>
                        <div className="flex flex-col items-center md:items-end">
                            {/* ISOLATED CLOCK COMPONENT - prevents page-wide re-renders */}
                            <ClockDisplay timezone={location.timezone} />
                            
                            <div className="flex gap-2 mt-4">
                                <button 
                                    onClick={() => setDivineMode(!divineMode)}
                                    className={`p-2 rounded-full border transition-all ${divineMode ? 'bg-pink-500/20 border-pink-400 text-pink-200 shadow-[0_0_15px_hotpink]' : 'bg-white/5 border-white/10 text-slate-400'}`}
                                >
                                    <Icon name={divineMode ? "sparkles" : "moon"} size={16} />
                                </button>
                                <button 
                                    onClick={isSorting ? handleSaveOrder : () => setIsSorting(true)}
                                    className={`px-4 py-1 rounded-full text-xs font-bold font-mono border transition-all ${isSorting ? 'bg-green-500/20 border-green-500 text-green-300 animate-pulse' : 'bg-white/5 border-white/10 text-slate-400 hover:bg-white/10'}`}
                                >
                                    {isSorting ? "SAVE LAYOUT" : "SORT MODULES"}
                                </button>
                            </div>
                        </div>
                    </header>
                    
                    {isSorting && <div className="text-center text-purple-300 text-xs font-mono mb-6 animate-pulse">TAP A MODULE TO SELECT, TAP ANOTHER TO SWAP</div>}

                    {/* DYNAMIC GRID - Improved layout */}
                    <div className="portal-grid">
                        {moduleOrder.filter(id => id !== 'gcp').map(id => (
                            <ModuleWrapper key={id} id={id} colSpan={getColSpan(id)}>
                                {renderModule(id)}
                            </ModuleWrapper>
                        ))}

                        {/* News Ticker */}
                        <div className="col-span-12 mt-4">
                            <div onClick={() => toggleExpand('news', true)} className="relative glass-panel rounded-full h-12 flex items-center overflow-hidden border-pink-500/20 cursor-pointer hover:bg-slate-800/80 transition-colors">
                                <div className="absolute left-0 top-0 bottom-0 w-32 bg-gradient-to-r from-[#0f172a] to-transparent z-20 flex items-center pl-6 gap-2">
                                    <div className="w-2 h-2 bg-pink-500 rounded-full animate-pulse"></div>
                                    <span className="text-xs font-bold text-pink-400 tracking-widest hidden md:inline">NOOSPHERE</span>
                                </div>
                                <div className="flex w-full overflow-hidden">
                                    <div className="flex animate-marquee gap-8 items-center whitespace-nowrap pl-32 hover:pause">
                                        {[...newsData, ...newsData].map((item, i) => (
                                            <div key={i} className="flex items-center gap-3 text-sm font-mono text-pink-100/70">
                                                <span className="text-pink-500/50">âœ¦</span>
                                                <span className={item.source === "NOOSPHERE" || item.source === "GAIA" ? "text-purple-300 font-bold" : ""}>{item.title}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="absolute right-4 top-0 bottom-0 flex items-center z-30"><Icon name="chevron-up" size={16} className="text-pink-400" /></div>
                            </div>
                        </div>
                    </div>

                    {/* OVERLAYS */}
                    {expanded.moon && <Overlay title="Lunar Calendar" onClose={() => toggleExpand('moon', false)}>
                        <div className="grid grid-cols-7 gap-2 text-center text-xs font-mono mb-4 text-purple-300/50"><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div><div>S</div></div>
                        <div className="grid grid-cols-7 gap-2">
                            {monthlyMoons.map((m, i) => (
                                <div key={i} className={`aspect-square rounded-lg flex flex-col items-center justify-center border ${m.date === calcTime.getDate() ? 'bg-purple-500/20 border-purple-400' : 'bg-white/5 border-white/5'}`}>
                                    <div className="text-[10px] text-slate-500 mb-1">{m.date}</div><div className="text-xl" title={m.name}>{m.icon}</div>
                                </div>
                            ))}
                        </div>
                    </Overlay>}
                    
                    {expanded.solar && <Overlay title="Solar Activity (30 Days)" onClose={() => toggleExpand('solar', false)}>
                        <div className="space-y-4">
                            {solarData && solarData.length > 0 ? solarData.map((flare, i) => (
                                <div key={i} className="flex items-center justify-between p-4 rounded-xl bg-white/5 border border-white/5">
                                    <div className="flex items-center gap-4"><div className={`w-3 h-3 rounded-full ${flare.classType[0] === 'X' ? 'bg-red-500' : 'bg-orange-500'}`}></div><div><div className="font-bold text-slate-200">{flare.classType}</div><div className="text-xs text-slate-500">Region {flare.activeRegionNum}</div></div></div>
                                    <div className="text-right font-mono text-sm text-slate-400"><div>{new Date(flare.beginTime).toLocaleDateString()}</div></div>
                                </div>
                            )) : <div className="text-center py-10 text-slate-500">No recent major flares.</div>}
                        </div>
                    </Overlay>}
                    
                    {expanded.sky && <Overlay title="Full Planetary Alignment" onClose={() => toggleExpand('sky', false)}>
                        <div className="grid gap-3">
                            {planetInfo.map((p, i) => (
                                <div key={i} className="flex items-center justify-between p-4 rounded-xl bg-black/40 border border-white/10">
                                    <div className="flex items-center gap-4"><div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-slate-900 ${p.element==='Fire'?'bg-red-400':p.element==='Water'?'bg-blue-400':p.element==='Air'?'bg-yellow-200':'bg-green-400'}`}>{p.name[0]}</div><div><div className="font-bold text-slate-200">{p.name}</div><div className="text-xs text-cyan-300/70 uppercase">{p.element}</div></div></div>
                                    <div className="text-right"><div className="text-lg font-mono text-cyan-200">{p.sign}</div><div className="text-xs text-slate-500 font-mono">{p.degree}Â° {p.isRetrograde&&<span className="text-red-400 ml-2 font-bold bg-red-900/40 px-2 py-0.5 rounded">RETROGRADE</span>}</div></div>
                                </div>
                            ))}
                        </div>
                    </Overlay>}
                    
                    {expanded.weather && weatherData && <Overlay title={`Forecast: ${location.name.split(',')[0]}`} onClose={() => toggleExpand('weather', false)}>
                        <div className="grid gap-4">
                            {weatherData.daily.time.slice(0, 3).map((t, i) => {
                                const tempSymbol = weatherData.tempUnit === 'celsius' ? 'Â°C' : 'Â°F';
                                return (
                                    <div key={i} className="flex items-center justify-between p-4 rounded-xl bg-black/40 border border-white/10">
                                        <div className="flex items-center gap-4"><Icon name={getWeatherIcon(weatherData.daily.weathercode[i])} size={32} className="text-yellow-200" /><div><div className="font-bold text-slate-200">{i === 0 ? "Today" : new Date(t + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long' })}</div><div className="text-xs text-slate-500">H: {weatherData.daily.temperature_2m_max[i]}{tempSymbol} L: {weatherData.daily.temperature_2m_min[i]}{tempSymbol}</div></div></div>
                                        <div className="text-right text-xs font-mono text-slate-400"><div>Rise: {formatTime(weatherData.daily.sunrise[i])}</div><div>Set: {formatTime(weatherData.daily.sunset[i])}</div></div>
                                    </div>
                                );
                            })}
                        </div>
                    </Overlay>}
                    
                    {expanded.news && <Overlay title="Global & Cosmic Signals" onClose={() => toggleExpand('news', false)}>
                        <div className="space-y-4">
                            {newsData.map((item, i) => (
                                <a key={i} href={item.link !== "#" ? item.link : null} target="_blank" rel="noreferrer" className="block p-4 rounded-xl bg-white/5 hover:bg-pink-500/10 border border-white/5 hover:border-pink-500/30 transition-all">
                                    <div className="flex justify-between items-start mb-2"><span className="text-[10px] font-bold px-2 py-0.5 rounded bg-white/10 text-slate-300">{item.source || "SIGNAL"}</span></div>
                                    <div className="font-bold text-pink-100">{item.title}</div>
                                </a>
                            ))}
                        </div>
                    </Overlay>}

                    <footer className="mt-16 text-center opacity-40 hover:opacity-100 transition-opacity">
                        <p className="text-[10px] font-mono tracking-[0.3em] text-purple-300">PORTAL ID: SAC-8812 â€¢ SYNCHRONIZED</p>
                    </footer>
                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<CelestialPortal />);
</script>

</body>
</html>
